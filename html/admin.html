<html>
  <head>
    <title>CTF Scoreboard</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/pure-min.css">
    <link href="/css/roboto.css" rel="stylesheet">
  </head>
  <body>
    <div id="main" class="center">
      <a id="logoutButton" href="#">Logout</a> |
      <a href="/register">Register a new team</a>
      <h1>Post a Message</h1>
      <div class="center">
        <form action="/message" method="post" class="pure-form pure-form-aligned">
          <fieldset>
            <div class="pure-control-group">
              <label for="message">Message:</label>
              <textarea id="messageContent" name="message"></textarea>
            </div>
            <div class="pure-controls">
              <button id="postMessage" type="submit" class="pure-button pure-button-primary">Submit</button>
            </div>
          </fieldset>
        </form>
      </div>
      <h1>Registered Teams</h1>
      <table id="teams">
        <tr id="teamsheader">
          <th></th>
          <th>Team Name</th>
          <th>Submission Token</th>
        </tr>
      </table>
    </div>
    <script>
(function () {
    const postMsgBtn = document.getElementById('postMessage');
    const logoutBtn = document.getElementById('logoutButton');
    const teams = document.getElementById('teams');

    displayTeams();

    postMsgBtn.addEventListener('click', (evt) => {
        evt.preventDefault();
        postMessage();
    });

    logoutBtn.addEventListener('click', () => {
        document.cookie = 'session=;expires=Thu, 01 Jan 1970 00:00:01 GMT"';
        window.location = '/';
    });

    function deleteTeam (evt) {
        const name = evt.target.attributes.getNamedItem('data-name').value;
        const id = Number(evt.target.attributes.getNamedItem('data-id').value);

        if (!confirm(`Are you sure you want to delete the team "${name}"?`)) {
            return;
        }

        let request = new XMLHttpRequest();
        request.addEventListener('load', () => {
            const response = JSON.parse(request.responseText);
            console.log('Got response', request.responseText);
            if (response.error !== null) {
                alert(`Error deleting team. Reason: ${response.error}`);
            } else {
                document.location = '/admin';
            }
        });
        request.open('DELETE', `/teams?id=${id}`, true);
        request.send();
    }

    function displayTeams() {
        const xhr = new XMLHttpRequest();

        xhr.addEventListener('load', () => {
            const response = JSON.parse(xhr.responseText);

            if (response.error !== null) {
                alert(`Could not get information about teams. ERROR: ${response.error}`);
                return;
            }

            const teamsHeader = document.getElementById('teamsheader');
            for (let i = 0; i < response.numFlags; i++) {
                const th = document.createElement('th');
                th.classList = 'flag';
                th.innerHTML = `${i + 1}`;
                teamsHeader.appendChild(th);
            }

            for (const team of response.teams) {
                const teamRow = document.createElement('tr');
                const deleteBtnTd = document.createElement('td');
                const teamNameTd = document.createElement('td');
                const submitTokenTd = document.createElement('td');
                const deleteLink = document.createElement('a');

                deleteLink.setAttribute('href', '#');
                deleteLink.setAttribute('data-id', team.id);
                deleteLink.setAttribute('data-name', team.name);
                deleteLink.classList = 'delete-team-btn';
                deleteLink.innerHTML = 'Delete';
                deleteLink.addEventListener('click', deleteTeam);

                teamNameTd.innerHTML = team.name;
                submitTokenTd.innerHTML = team.submitToken;

                deleteBtnTd.appendChild(deleteLink);
                teamRow.appendChild(deleteBtnTd);
                teamRow.appendChild(teamNameTd);
                teamRow.appendChild(submitTokenTd);

                for (const submitted of team.submittedFlags) {
                    const flagTd = document.createElement('td');
                    flagTd.innerHTML = submitted ? 'âœ”' : ' ';
                    teamRow.appendChild(flagTd);
                }

                teams.appendChild(teamRow);
            }
        });

        const cookieParts = document.cookie.split('=');
        if (cookieParts.length != 2) {
            window.href = '/';
            return;
        }
        xhr.open('GET', `/admin/teams?session=${cookieParts[1]}`);
        xhr.send();
    }

    function postMessage() {
        const messageContent = document.getElementById('messageContent');
        const xhr = new XMLHttpRequest();
        
        const cookieParts = document.cookie.split('=');
        if (cookieParts.length != 2) {
            window.href = '/';
            return;
        }

        xhr.open('POST', '/admin/messages');
        xhr.addEventListener('load', () => {
            const response = JSON.parse(xhr.responseText);
            if (response.error !== null) {
                alert(`ERROR: ${response.error}`);
            } else {
                alert('Successfully posted your message.');
                messageContent.value = '';
            }
        });
        xhr.send(JSON.stringify({
            session: cookieParts[1],
            content: messageContent.value
        }));
    }
})();
    </script>
  </body>
</html>
